# HTTP

## HTTP 的发展

<!-- TODO:  -->

HTTP 最初的版本为 0.9，仅定义了建立 TCP 连接后，客户端向服务端请求的资源，进行支持 GET 方法； <br>
HTTP 1.0 版本初步定义了传输规则：增加了 POST、HEAD 方法，增加了 Header 头，定义了状态码且支持任意格式数据 <br>
HTTP 1.1 版本除了完善传输规则并增加了 持久连接、管道机制、缓存控制、断电续传、虚拟网络 等特性 <br>
目前 1.1 版本也是主要使用的版本，由于 HTTP 的数据为明文传输，存在安全隐患，因而发展出了 HTTPS 协议 <br>
HTTPS 使用证书确保通信双方可信，传输时对数据加密避免被第三方接持 <br>
HTTP 2 优化了通信效率，

## HTTP 1.x

- 引入持久链接，TCP 连接默认不关闭可被多个请求复用
- 引入管道机制，在一个 TCP 连接中可以同发送多个请求
- 优化缓存控制，增加多个缓存控制头标识来控制缓存失效
- 支持断点续传，通过请求头中的 Range 实现
- 完善请求方法，增加 PUT|PATCH|OPTIONS|DELETE 方法
- 支持虚拟网络，一台物理服务器可以存在多个虚拟主机，且共享同一 IP

存在的问题

- 明文传输
- 队头阻塞：请求管道化带来的新问题，默认关闭(管道)
- 持久链接会带来更大的服务器压力

由存在对头阻塞问题，HTTP1.x 中仍然使用并发连接(Chrome 默认 6 各)和域名分片(根据二级域名划分业务提高最大并发)

### 请求方法

GET
POST
PUT
DELETE
OPTIONS
HEAD: 请求获取资源的响应消息头
TRACE: 请求服务器回送收到的请求信息，主要用于测试或诊断
CONNECT: 建立连接隧道，用于代理服务器

### 响应状态码

HTTP 状态码为用于表示响应状态的三位数字，其首位代表状态类别

- 1xx：消息类状态
- 2xx：成功类状态，如：200-成功
- 3xx：重定向状态，如：301-永久重定向，302-临时重定向，304-命中协商缓存，305-指定访问代理
- 4xx：客户端错误，如：401-用户未认证，403-请求被拒绝，404-资源不存在，405-请求方法错误
- 5xx：服务端错误，如：500-服务器异常，502-网关错误，503-服务器维护或过载，504-网关超时，505-HTTP 版本不支持

### 持久连接

### 缓存控制

在实际应用中存在大量重复的资源获取，在获取资源时会优先进行强缓存匹配，若命中失败，则发送 HTTP 请求由服务端判断是否命中协商缓存；借助合理的缓存控制可以大幅提高资源获取效率。

#### 缓存位置

客户端查询缓存时依据以下缓存位置的优先级进行

1. Service Worker：用于 PWA，缓存可自由控制且持续
2. Memory Cache：效率高，容量小，时效短(进程关闭时释放)，常见于页面刷新和预加载(preloader)
3. Disk Cache：效率低，容量大，时效长，客户端最常见的缓存方式
4. Push Cache：HTTP2，只在会话中存在，且缓存只能被使用依次

#### 缓存策略

通常客户端的缓存策略分为两种

- 强缓存：不会发送请求，直接从 Memory Cache 和 Disk Cache 中获取
- 协商缓存：强缓存未命中时发起请求，由服务端判断是否命中缓存

强缓存根据 `Cache-Control` 或 `Expires` 字段判断是否命中，命中时返回 `200` 和 `from memory/disk cache`

- `Expires: [具体时间]`: HTTP1.0，存在服务端与客户端时间不一的问题
- `Cache-Control: [指令]`: HTTP1.1，优先级高于 `Expires`，多个指令使用逗号分隔
  - `max-age=xxx`: 单位秒，表示最大缓存时间
  - `s-maxage=xxx`: 覆盖 `max-age`，只在代理服务器中生效
  - `no-store`: 不缓存
  - `no-cache`: 资源被缓存但立即失效，下次请求时走协商缓存
  - `public`: 表示响应可被客户端和代理服务器缓存
  - `private`: 表示响应只可被客户端缓存
  - `max-stale=xxx`: 可容忍最大过期时间，指定时间内即使过期也使用当前缓存
  - `min-fresh=xxx`: 可容忍最小新鲜度，指定时间内希望获取最新响应

协商缓存根据 `Last-Modified` 或 `Etag` 字段判断是否使用缓存，命中时返回 `304` 和 `Not Modified`

- `Last-Modified: [具体时间]`: HTTP1.1，根据资源修改时间判断是否使用缓存(存在精度、负载均衡服务器中时间不一致问题)
  - 客户端首次请求时，服务端在响应头添加 `Last-Modified` 字段
  - 客户端再次请求时，客户端在请求头添加 `If-Modified-Since` 字段(值同上次返回的 `Last-Modified`)
  - 服务端接收请求后，根据 `If-Modified-Since` 与对应资源最后修改时间进行对比判断是否使用缓存
- `ETag: [资源标识]`: HTTP1.1，优先级更高，根据资源内容生成的唯一标识判断是否使用缓存(会有额外开销)
  - 服务端根据资源内容生成对应的唯一标识
  - 客户端首次请求时，服务端在响应头添加 `ETag` 字段
  - 客户端再次请求时，客户端在请求头添加 `If-None-Match` 字段(值同上次返回的 `ETag`)
  - 服务端接收请求后，根据 `If-None-Match` 与对应资源的 `ETag` 进行比对判断是否使用缓存

## HTTPS

## HTTP 2

进一步优化了通信性能

- 二进制分帧：引入头信息帧和数据帧
- 请求优先级：可以设置数据帧优先级，优化处理顺序
- 多路复用：用于解决队头阻塞问题
- 头部压缩：用于优化 Header 信息占比过重的请求 (`HPACK` 算法)
- 服务端推送：允许服务端主动向客户端推送

[HPACK](https://blog.csdn.net/u010129119/article/details/79392545)
